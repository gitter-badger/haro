{"version":3,"sources":["../../src/server/haro.js"],"names":[],"mappings":"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","file":"haro.js","sourcesContent":["import fetch from \"node-fetch\";\nimport tuple from \"tiny-tuple\";\nimport { clone, deferred, merge, uuid } from \"./utility\";\n\nexport class Haro {\n\tconstructor ( data ) {\n\t\tthis.data = new Map();\n\t\tthis.config = {\n\t\t\tmethod: \"get\",\n\t\t\tcredentials: false,\n\t\t\theaders: {\n\t\t\t\taccept: \"application/json\",\n\t\t\t\t\"content-type\": \"application/json\"\n\t\t\t}\n\t\t};\n\t\tthis.registry = [];\n\t\tthis.key = \"\";\n\t\tthis.source = \"\";\n\t\tthis.total = 0;\n\t\tthis.uri = \"\";\n\t\tthis.versions = new Map();\n\n\t\tif ( data ) {\n\t\t\tthis.batch( data, \"set\" );\n\t\t}\n\t}\n\n\tbatch ( args, type ) {\n\t\tlet defer = deferred(),\n\t\t    promises = [];\n\n\t\tif ( type === \"del\" ) {\n\t\t\targs.forEach( i => {\n\t\t\t\t promises.push( this.del( i, true ) );\n\t\t\t} );\n\t\t} else {\n\t\t\targs.forEach( i => {\n\t\t\t\tpromises.push( this.set( null, i, true ) );\n\t\t\t} );\n\t\t}\n\n\t\tPromise.all( promises ).then( function ( arg ) {\n\t\t\tdefer.resolve( arg );\n\t\t}, function ( e ) {\n\t\t\tdefer.reject( e );\n\t\t} );\n\n\t\treturn defer.promise;\n\t}\n\n\tclear () {\n\t\tthis.total = 0;\n\t\tthis.registry = [];\n\t\tthis.data.clear();\n\t\tthis.versions.clear();\n\n\t\treturn this;\n\t}\n\n\tdel ( key, batch=false ) {\n\t\tlet defer = deferred(),\n\t\t\tindex;\n\n\t\tlet next = () => {\n\t\t\tindex = this.registry.indexOf( key );\n\n\t\t\tif ( index > -1 ) {\n\t\t\t\tif ( index === 0 ) {\n\t\t\t\t\tthis.registry.shift();\n\t\t\t\t} else if ( index === ( this.registry.length - 1 ) ) {\n\t\t\t\t\tthis.registry.pop();\n\t\t\t\t} else {\n\t\t\t\t\tthis.registry.splice( index, 1 );\n\t\t\t\t}\n\n\t\t\t\tthis.data.delete( key );\n\t\t\t\tthis.versions.delete( key );\n\t\t\t\t--this.total;\n\t\t\t}\n\n\t\t\tdefer.resolve();\n\t\t};\n\n\t\tif ( this.data.has( key ) ) {\n\t\t\tif ( !batch && this.uri ) {\n\t\t\t\tthis.request( this.uri.replace( /\\?.*/, \"\" ) + \"/\" + key, {method: \"delete\"} ).then( next, function ( e ) {\n\t\t\t\t\tdefer.reject( e[0] || e );\n\t\t\t\t} );\n\t\t\t} else {\n\t\t\t\tnext()\n\t\t\t}\n\t\t} else {\n\t\t\tdefer.reject( new Error( \"Record not found\" ) );\n\t\t}\n\n\t\treturn defer.promise;\n\t}\n\n\tentries () {\n\t\treturn this.data.entries();\n\t}\n\n\tfilter ( fn ) {\n\t\tlet result = [];\n\n\t\tthis.forEach( function ( value, key ) {\n\t\t\tif ( fn( clone( value ), clone( key ) ) === true ) {\n\t\t\t\tresult.push( tuple( key, value ) );\n\t\t\t}\n\t\t} );\n\n\t\treturn tuple.apply( tuple, result );\n\t}\n\n\tforEach ( fn, ctx ) {\n\t\treturn this.data.forEach( fn, ctx );\n\t}\n\n\tget ( key ) {\n\t\tlet output;\n\n\t\tif ( this.data.has( key ) ) {\n\t\t\toutput = tuple( key, this.data.get( key ) );\n\t\t}\n\n\t\treturn output;\n\t}\n\n\tkeys () {\n\t\treturn this.data.keys();\n\t}\n\n\tlimit ( start=0, offset=0 ) {\n\t\tlet i = start,\n\t\t    nth = start + offset,\n\t\t    list = [],\n\t\t    k;\n\n\t\tif ( i < 0 || i >= nth ) {\n\t\t\tthrow new Error( \"Invalid range\" );\n\t\t}\n\n\t\tdo {\n\t\t\tk = this.registry[ i ];\n\n\t\t\tif ( k ) {\n\t\t\t\tlist.push( this.get( k ) );\n\t\t\t}\n\t\t} while ( ++i < nth );\n\n\t\treturn tuple.apply( tuple, list );\n\t}\n\n\tmap ( fn ) {\n\t\tlet result = [];\n\n\t\tthis.forEach( function ( value, key ) {\n\t\t\tresult.push( tuple( key, fn( clone( value ), clone( key ) ) ) );\n\t\t} );\n\n\t\treturn tuple.apply( tuple, result );\n\t}\n\n\trequest ( input, config={} ) {\n\t\tlet cfg = merge( this.config, config );\n\n\t\treturn fetch( input, cfg ).then( function( res ) {\n\t\t\treturn res[ res.headers.get( \"content-type\").indexOf( \"application/json\" ) > -1 ? \"json\" : \"text\" ]().then( function ( arg ) {\n\t\t\t\tif ( res.status === 0 || res.status >= 400 ) {\n\t\t\t\t\tthrow tuple( arg, res.status );\n\t\t\t\t}\n\n\t\t\t\treturn tuple( arg, res.status );\n\t\t\t}, function ( e ) {\n\t\t\t\tthrow tuple( e.message, res.status );\n\t\t\t} );\n\t\t}, function ( e ) {\n\t\t\tthrow tuple( e.message, 0 );\n\t\t} );\n\t}\n\n\tset ( key, data, batch=false, override=false ) {\n\t\tlet defer = deferred(),\n\t\t    method = \"post\",\n\t\t    ldata = clone( data ),\n\t\t\tnext;\n\n\t\tnext = () => {\n\t\t\tif (method === \"post\" ) {\n\t\t\t\t++this.total;\n\t\t\t\tthis.registry.push( key );\n\t\t\t\tthis.versions.set( key, new Set() );\n\t\t\t} else {\n\t\t\t\tthis.versions.get( key ).add( tuple( this.data.get( key ) ) );\n\t\t\t}\n\n\t\t\tthis.data.set( key, ldata );\n\t\t\tdefer.resolve( this.get( key ) );\n\t\t};\n\n\t\tif ( key === undefined || key === null ) {\n\t\t\tkey = this.key ? ldata[ this.key ] : uuid() || uuid();\n\t\t} else if ( this.data.has( key ) ) {\n\t\t\tmethod = \"put\";\n\n\t\t\tif ( !override ) {\n\t\t\t\tldata = merge( this.get( key )[ 1 ], ldata );\n\t\t\t}\n\t\t}\n\n\t\tif ( !batch && this.uri ) {\n\t\t\tthis.request( this.uri.replace( /\\?.*/, \"\" ) + \"/\" + key, { method: method, body: JSON.stringify( ldata ) } ).then( next, function ( e ) {\n\t\t\t\tdefer.reject( e[0] || e );\n\t\t\t} );\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\n\t\treturn defer.promise;\n\t}\n\n\tsetUri ( uri ) {\n\t\tlet defer = deferred();\n\n\t\tthis.uri = uri;\n\n\t\tif ( this.uri ) {\n\t\t\tthis.request( this.uri ).then( arg => {\n\t\t\t\tlet data = arg[ 0 ];\n\n\t\t\t\tif ( this.source ) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tthis.source.split( \".\" ).forEach( function ( i ) {\n\t\t\t\t\t\t\tdata = data[ i ];\n\t\t\t\t\t\t} );\n\t\t\t\t\t} catch ( e ) {\n\t\t\t\t\t\treturn defer.reject( e );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.batch( data, \"set\" ).then( function ( records ) {\n\t\t\t\t\tdefer.resolve( records );\n\t\t\t\t}, function ( e ) {\n\t\t\t\t\tdefer.reject( e );\n\t\t\t\t} );\n\t\t\t}, function ( e ) {\n\t\t\t\tdefer.reject( e[0] || e );\n\t\t\t} )\n\t\t} else {\n\t\t\tdefer.resolve();\n\t\t}\n\n\t\treturn defer.promise;\n\t}\n\n\tvalues () {\n\t\treturn this.data.values();\n\t}\n}\n"]}